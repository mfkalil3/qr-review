<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Share Your Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand: #b91c1c }
    .brand-bg  { background-color: var(--brand) }
    .brand-txt { color: var(--brand) }
    .brand-ring{ --tw-ring-color: var(--brand) }
    .smooth    { transition: all 220ms ease }
    .card      { box-shadow: 0 10px 30px rgba(0,0,0,.06) }

    .chip {
      display:inline-flex; align-items:center; gap:.4rem;
      border:1.5px solid #e2e8f0; padding:.44rem .8rem; border-radius:9999px;
      font-size:.875rem; background:#fff;
    }
    .chip:hover { background:#f8fafc }
    .chip[aria-pressed="true"] { color:#fff; background:var(--brand); border-color:transparent }
    details > summary::-webkit-details-marker { display:none }

    /* Step transitions */
    .step-enter { opacity: 0; transform: translateY(6px); }
    .step-enter-active { opacity: 1; transform: translateY(0); transition: all 260ms ease; }
    .step-leave { opacity: 1; transform: translateY(0); }
    .step-leave-active { opacity: 0; transform: translateY(-6px); transition: all 200ms ease; }

    /* Tiny dot stepper */
    .dot { height:6px; width:18px; border-radius:9999px; transition: all 200ms ease; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-200 text-slate-800 antialiased">
  <main class="mx-auto max-w-3xl px-4 py-10">
    <section class="mx-auto max-w-2xl rounded-2xl bg-white card ring-1 ring-black/5 overflow-hidden">
      <!-- Header -->
      <header class="p-6 sm:p-8 border-b border-slate-100">
        <h1 id="title" class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Share your experience at <span id="restName" class="brand-txt">Sahara</span>
        </h1>
      </header>

      <!-- Body -->
      <div class="p-6 sm:p-8 space-y-10">

        <!-- STEP 1 ‚Äî EXPERIENCE -->
        <section id="experience" aria-labelledby="exp-title">
          <h2 id="exp-title" class="text-xl sm:text-2xl font-semibold">How was your experience today?</h2>
          <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <button type="button" data-exp="Excellent" class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Excellent">
              <div class="text-2xl">ü§©</div>
              <div class="mt-1 text-base font-medium">Excellent</div>
              <p class="text-sm text-slate-500">Everything sang.</p>
            </button>
            <button type="button" data-exp="Good" class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Good">
              <div class="text-2xl">üôÇ</div>
              <div class="mt-1 text-base font-medium">Good</div>
              <p class="text-sm text-slate-500">Worth sharing.</p>
            </button>
            <button type="button" data-exp="Not great" class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Not great">
              <div class="text-2xl">üòï</div>
              <div class="mt-1 text-base font-medium">Not great</div>
              <p class="text-sm text-slate-500">Tell us why.</p>
            </button>
          </div>
        </section>

        <!-- POSITIVE PATH -->
        <section id="positive" class="hidden" aria-hidden="true">
          <!-- Top row: Google + AI -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-center">
            <a id="googleTopLink" target="_blank" rel="noopener noreferrer"
               class="inline-flex items-center justify-center rounded-lg px-4 py-3 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth disabled:opacity-40 disabled:pointer-events-none"
               aria-label="Open Google to post">
              ‚≠ê <span class="ml-2">Open Google to post</span>
            </a>

            <button id="revealAi" type="button"
                    class="inline-flex items-center justify-center rounded-lg px-4 py-3 border border-[var(--brand)] text-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth"
                    aria-label="Help me with AI">
              ‚ú® Help me with AI
            </button>
          </div>
          <p id="googleTipTop" class="mt-2 text-sm text-slate-500"></p>

          <!-- AI WIZARD -->
          <div id="craftWrap" class="hidden mt-6">
            <div id="wizard" class="rounded-xl border border-slate-200 p-5 sm:p-6">
              <div class="flex items-start justify-between">
                <div>
                  <h2 class="text-xl sm:text-2xl font-semibold">Craft your review</h2>
                  <p id="wizSub" class="mt-1 text-sm text-slate-600">Answer a few quick questions, or skip later.</p>
                </div>
                <div class="text-right">
                  <div id="wizProgress" class="text-sm text-slate-500">Step 1 of 8</div>
                  <div id="wizDots" class="mt-2 flex items-center gap-1.5" aria-hidden="true"></div>
                </div>
              </div>

              <div id="wizContent" class="mt-5 step-enter step-enter-active"><!-- dynamic --></div>

              <div class="mt-6 flex flex-wrap gap-3 justify-between">
                <div class="flex gap-3">
                  <button id="wizBack" type="button" class="rounded-lg px-4 py-2 border border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 smooth" aria-label="Back">Back</button>
                </div>
                <div class="flex gap-3">
                  <button id="wizSkipAll" type="button" class="rounded-lg px-4 py-2 border border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 smooth" aria-label="Skip to review">Skip to review</button>
                  <button id="wizNext" type="button" class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Next">Next</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- NEGATIVE PATH -->
        <section id="negative" class="hidden" aria-hidden="true">
          <div id="negForm">
            <div class="text-center">
              <div class="text-4xl">üôè</div>
              <h2 class="mt-3 text-xl sm:text-2xl font-semibold">Thank you for your honesty.</h2>
              <p class="mt-2 text-slate-600">A few quick questions help the team improve.</p>
            </div>

            <div class="mt-6 space-y-6">
              <div>
                <p class="text-sm font-medium text-slate-700">Did you dine in, take out, or get delivery?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-dining"></div>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-700">What did you get?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-meal"></div>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-700">How much did you spend per person?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-spend"></div>
              </div>
              <div>
                <label for="negFeedback" class="text-sm font-medium text-slate-700">Your feedback (optional)</label>
                <textarea id="negFeedback" rows="4" class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-3" placeholder="Write any details you'd like the manager to know‚Ä¶"></textarea>
              </div>
              <div class="flex items-center gap-3">
                <button id="sendNegative" type="button" class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth">Send</button>
                <span id="negStatus" class="text-sm text-slate-600" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <div id="negDone" class="hidden text-center py-10">
            <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-green-100 text-green-700 text-3xl">‚úì</div>
            <h3 class="mt-4 text-lg font-semibold">Your feedback was sent to the restaurant.</h3>
            <p class="mt-2 text-slate-600">We appreciate your time.</p>
          </div>
        </section>

      </div>
    </section>
  </main>

  <!-- aria-live region -->
  <div id="sr-live" class="sr-only" aria-live="polite"></div>

  <script>
    /* ======== CONFIG ======== */
    var DATA_URL = "/data/tenants/sahara.json"; // static JSON dataset path

    /* ======== UTILITIES ======== */
    function qs(s, r){ return (r||document).querySelector(s); }
    function qsa(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
    function setBrand(hex){ document.documentElement.style.setProperty("--brand", hex || "#b91c1c"); }
    function copyText(t){
      if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(t);
      var ta=document.createElement("textarea"); ta.value=t; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
      return Promise.resolve();
    }
    function googleUrl(google){
      if (google && google.mapsUrl) return google.mapsUrl;
      if (google && google.placeId) return "https://search.google.com/local/writereview?placeid="+encodeURIComponent(google.placeId);
      return "";
    }

    /* ======== ANIMATION HELPERS ======== */
    function swapContent(container, newHTML, after){
      container.classList.remove('step-enter','step-enter-active');
      container.classList.add('step-leave');
      void container.offsetWidth;
      container.classList.add('step-leave-active');

      setTimeout(function(){
        container.innerHTML = newHTML;

        container.classList.remove('step-leave','step-leave-active');
        container.classList.add('step-enter');
        void container.offsetWidth;
        container.classList.add('step-enter-active');

        if (typeof after === 'function') after();

        setTimeout(function(){
          container.classList.remove('step-enter','step-enter-active');
        }, 280);
      }, 200);
    }

    /* ======== DRAFT REVIEW (fallback) ======== */
    function writeShortReview(args) {
      var name = args.name || "This restaurant";
      var exp = args.experience || "Good";
      var highlight = args.highlight || "";
      var keywords = args.keywords || [];
      var details = args.details || "";

      var openersGood = ["I stopped by","I visited","I had a meal at"];
      var openersEx   = ["Dinner at","An evening at","My visit to"];
      var opener = (exp === "Excellent" ? openersEx : openersGood)[Math.floor(Math.random()*3)];

      var k = keywords.slice(0,3);
      var dishLine = k.length ? (" The " + k.join(", ") + (k.length===1?" was":" were") + " well prepared and full of flavor.") : "";
      var hlMap = {
        "Food":" The kitchen‚Äôs attention to detail showed. üçΩ",
        "Service":" Service was attentive and well-timed. ü§ù",
        "Atmosphere":" The room felt calm and welcoming. üåÜ",
        "Authenticity":" Flavors felt thoughtful and true to the cuisine. üåç"
      };
      var hl = hlMap[highlight] || "";
      var extra = details ? (" " + details + ".") : "";
      var closer = (exp==="Excellent") ? " Highly recommended." : " I‚Äôd happily return.";
      return opener + " " + name + " was " + exp.toLowerCase() + "." + dishLine + hl + extra + closer;
    }
    function detailsSummary(d){
      var parts=[];
      if (d.veg) parts.push("Vegetarian options: " + d.veg);
      if (d.diet && d.diet.length) parts.push("Dietary: " + d.diet.join(", "));
      if (d.parking) parts.push("Parking: " + d.parking);
      if (d.kids && d.kids.length) parts.push("Kid-friendliness: " + d.kids.join(", "));
      if (d.access && d.access.length) parts.push("Accessibility: " + d.access.join(", "));
      return parts.join(" | ");
    }

    /* ======== TYPEWRITER ======== */
    function typeTextIntoTextarea(el, fullText, speed){
      return new Promise(function(resolve){
        el.value = "";
        var i = 0;
        (function tick(){
          el.value = fullText.slice(0, i);
          i++;
          if (i <= fullText.length){
            setTimeout(tick, speed);
          } else {
            resolve();
          }
        })();
      });
    }

    /* ======== STATE ======== */
    var state = {
      tenant: null,
      experience: null,
      highlight: null,
      selectedTags: new Set(),
      showAllKw: false,
      posDetails: { veg:null, diet:[], parking:null, kids:[], access:[] },
      neg: { dining:null, meal:null, spend:null, feedback:"" },
      wizStep: 0
    };

    /* ======== CHIPS ======== */
    function makeChip(text, pressed, onClick){
      var b=document.createElement("button");
      b.type="button"; b.className="chip smooth"; b.setAttribute("aria-pressed", pressed?"true":"false");
      b.textContent = text;
      b.addEventListener("click", onClick || function(){});
      return b;
    }

    function renderKeywords(){
      var wrap=qs("#kwWrap"); if (!wrap) return; wrap.innerHTML="";
      var list = (state.tenant && state.tenant.keywords) ? state.tenant.keywords : [];
      var max = state.showAllKw ? list.length : Math.min(16, list.length);
      for (var i=0;i<Math.min(max, list.length);i++){
        (function(k){
          var pressed = state.selectedTags.has(k);
          wrap.appendChild(makeChip(k, pressed, function(){
            var on = state.selectedTags.has(k);
            if (!on && state.selectedTags.size>=3) return;
            if (on) state.selectedTags.delete(k); else state.selectedTags.add(k);
            renderKeywords();
          }));
        })(list[i]);
      }
      var t = qs("#kwToggle");
      if (t){
        if (list.length<=16) t.classList.add("hidden");
        else {
          t.classList.remove("hidden");
          t.textContent = state.showAllKw ? "See fewer" : "See more";
        }
      }
    }

    function renderHighlights(){
      var wrap=qs("#hlWrap"); if (!wrap) return; wrap.innerHTML="";
      var opts = (state.tenant && state.tenant.highlightOptions) ? state.tenant.highlightOptions : ["Food","Service","Atmosphere","Authenticity"];
      for (var i=0;i<opts.length;i++){
        (function(h){
          var pressed = state.highlight===h;
          wrap.appendChild(makeChip(h, pressed, function(){
            state.highlight = (state.highlight===h) ? null : h;
            renderHighlights();
          }));
        })(opts[i]);
      }
    }

    function chipGroup(sel, options, multi, getter, setter){
      var wrap=qs(sel); if (!wrap) return; wrap.innerHTML="";
      var current = getter();
      var selSet = new Set(Array.isArray(current) ? current : (current ? [current] : []));
      for (var i=0;i<options.length;i++){
        (function(opt){
          wrap.appendChild(makeChip(opt, selSet.has(opt), function(){
            var on = selSet.has(opt);
            if (multi){ if (on) selSet.delete(opt); else selSet.add(opt); setter(Array.from(selSet)); }
            else { selSet.clear(); selSet.add(opt); setter(opt); }
            chipGroup(sel, options, multi, getter, setter);
          }));
        })(options[i]);
      }
    }

    function buildPositiveDetailsUI(){
      chipGroup("#pos-veg", ["Yes","No","Not sure"], false, function(){return state.posDetails.veg;}, function(v){state.posDetails.veg=v;});
      chipGroup("#pos-diet", ["Gluten-free options","Vegan options","Halal options","Nut-aware","Dairy-free","Other"], true, function(){return state.posDetails.diet;}, function(v){state.posDetails.diet=v;});
      chipGroup("#pos-parking", ["Street","Lot","Valet","None / not sure"], false, function(){return state.posDetails.parking;}, function(v){state.posDetails.parking=v;});
      chipGroup("#pos-kids", ["Good for kids","High chairs","Kids menu","Not kid-focused"], true, function(){return state.posDetails.kids;}, function(v){state.posDetails.kids=v;});
      chipGroup("#pos-access", ["Step-free entrance","Accessible restroom","Good aisle spacing","Not sure"], true, function(){return state.posDetails.access;}, function(v){state.posDetails.access=v;});
    }

    function buildNegativeUI(){
      var nq = (state.tenant && state.tenant.negativeQuestions) ? state.tenant.negativeQuestions : {};
      chipGroup("#q-dining", nq.diningModes || ["Dine in","Take out","Delivery"], false, function(){return state.neg.dining;}, function(v){state.neg.dining=v;});
      chipGroup("#q-meal",   nq.meals || ["Breakfast","Brunch","Lunch","Dinner","Other"], false, function(){return state.neg.meal;}, function(v){state.neg.meal=v;});
      chipGroup("#q-spend",  nq.spendRanges || ["$1‚Äì10","$10‚Äì20","$20‚Äì30","$30‚Äì50","$50‚Äì100","$100+"], false, function(){return state.neg.spend;}, function(v){state.neg.spend=v;});
      var nf=qs("#negFeedback"); if (nf) nf.addEventListener("input", function(e){ state.neg.feedback = e.target.value; });
    }

    /* ======== DOTS ======== */
    var WIZ_IDS = ["kw","hl","veg","diet","parking","kids","access","review"];
    function renderDots(){
      var dots = qs("#wizDots"); if (!dots) return; dots.innerHTML="";
      for (var i=0;i<WIZ_IDS.length;i++){
        var d=document.createElement("div"); d.className="dot bg-slate-200";
        if (i < state.wizStep) d.style.background = "rgba(185,28,28,.35)";
        if (i === state.wizStep){ d.style.background = "var(--brand)"; d.style.width="24px"; }
        dots.appendChild(d);
      }
    }

    /* ======== WIZARD ======== */
    function renderWizardStep(){
      var id = WIZ_IDS[state.wizStep];
      var total = WIZ_IDS.length;
      qs("#wizProgress").textContent = "Step " + (state.wizStep+1) + " of " + total;

      var c = qs("#wizContent");
      var back = qs("#wizBack");
      var next = qs("#wizNext");
      var skipAll = qs("#wizSkipAll");
      var sub = qs("#wizSub");

      back.disabled = (state.wizStep === 0);
      if (state.wizStep < 2) skipAll.classList.add("invisible"); else skipAll.classList.remove("invisible");

      sub.classList.remove("hidden");
      next.classList.remove("hidden");

      var html="";
      if (id === "kw"){
        html =
          '<div>'+
            '<div class="flex items-center justify-between">'+
              '<p class="text-sm font-medium text-slate-700">Pick up to 3 keywords</p>'+
              '<button id="kwToggle" type="button" class="text-sm text-slate-600 hover:text-slate-800 focus:outline-none focus-visible:ring-2 brand-ring rounded-md px-2 py-1 smooth">See more</button>'+
            '</div>'+
            '<div id="kwWrap" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){
          renderKeywords();
          var t=qs("#kwToggle"); if(t){ t.addEventListener("click", function(){ state.showAllKw=!state.showAllKw; renderKeywords(); }); }
        });
      }
      else if (id === "hl"){
        html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">What stood out the most?</p>'+
            '<div id="hlWrap" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){ renderHighlights(); });
      }
      else if (id === "veg"){
        html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Vegetarian options?</p>'+
            '<div id="pos-veg" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){ buildPositiveDetailsUI(); });
      }
      else if (id === "diet"){
        html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Any dietary considerations?</p>'+
            '<div id="pos-diet" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){ buildPositiveDetailsUI(); });
      }
      else if (id === "parking"){
        html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Parking</p>'+
            '<div id="pos-parking" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){ buildPositiveDetailsUI(); });
      }
      else if (id === "kids"){
        html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Kid-friendliness</p>'+
            '<div id="pos-kids" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){ buildPositiveDetailsUI(); });
      }
      else if (id === "access"){
        html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Wheelchair accessibility</p>'+
            '<div id="pos-access" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';

        swapContent(c, html, function(){ buildPositiveDetailsUI(); });
      }
      else if (id === "review"){
        sub.classList.add("hidden");
        next.classList.add("hidden");
        skipAll.classList.add("invisible");

        html =
          '<div>'+
            '<div class="flex items-center justify-between">'+
              '<label for="reviewText" class="text-sm font-medium text-slate-700">Your review</label>'+
              '<label class="inline-flex items-center gap-2 cursor-pointer">'+
                '<input id="editToggle" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-[var(--brand)] focus:ring-[var(--brand)]" checked />'+
                '<span class="text-sm text-slate-700">Enable editing</span>'+
              '</label>'+
            '</div>'+
            '<textarea id="reviewText" rows="5" class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-4 text-[15px] leading-6" aria-describedby="copyHelp" placeholder="Generating‚Ä¶"></textarea>'+
            '<p id="copyHelp" class="mt-2 text-sm text-slate-500">Copy and paste to Google when ready.</p>'+
            '<div class="mt-3 flex flex-wrap items-center gap-3">'+
              '<button id="aiBtn" type="button" class="rounded-lg px-4 py-2 border border-[var(--brand)] text-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth">‚ú® Polish with AI</button>'+
              '<button id="copyBtn" type="button" disabled class="rounded-lg px-4 py-2 text-white bg-slate-700 disabled:opacity-40 disabled:pointer-events-none hover:brightness-95 focus:outline-none focus-visible:ring-2 smooth"><span class="btn-label">Copy</span></button>'+
              '<span id="aiStatus" class="text-sm text-slate-600" aria-live="polite"></span>'+
            '</div>'+
          '</div>';

        swapContent(c, html, function(){
          var ed=qs("#editToggle");
          ed.addEventListener("change", function(){
            var ta=qs("#reviewText");
            if (ed.checked) ta.removeAttribute("readonly"); else ta.setAttribute("readonly","");
          });
          attachCopyBehavior();
          generateReview(true); // auto, with typewriter
          qs("#aiBtn").addEventListener("click", function(){ generateReview(true); }); // regenerate, type again
        });
      }

      renderDots();
    }

    function wizardNext(){ if (state.wizStep < WIZ_IDS.length-1){ state.wizStep++; renderWizardStep(); } }
    function wizardBack(){ if (state.wizStep > 0){ state.wizStep--; renderWizardStep(); } }
    function wizardSkipAll(){ state.wizStep = WIZ_IDS.indexOf("review"); renderWizardStep(); }

    /* ======== AI / FALLBACK ======== */
    function generateReview(withTyping){
      var status=qs("#aiStatus"); if (status) status.textContent="Polishing‚Ä¶";
      var details = detailsSummary(state.posDetails);
      var body = {
        restaurant: (state.tenant && state.tenant.name) ? state.tenant.name : "This restaurant",
        experience: state.experience || "Good",
        highlight: state.highlight || "Food",
        keywords: Array.from(state.selectedTags),
        extra: details
      };
      function finish(text, usedAI){
        var ta=qs("#reviewText"); var copyBtn=qs("#copyBtn");
        var speed = 12; // ms per char (typewriter)
        if (withTyping){
          ta.setAttribute("readonly",""); // avoid caret flicker while typing
          typeTextIntoTextarea(ta, text, speed).then(function(){
            ta.removeAttribute("readonly");
            copyBtn.removeAttribute("disabled");
            if (status) status.textContent = usedAI ? "AI suggestion applied." : "Draft created.";
          });
        } else {
          ta.value = text;
          copyBtn.removeAttribute("disabled");
          if (status) status.textContent = usedAI ? "AI suggestion applied." : "Draft created.";
        }
      }
      // Try Netlify Function; fall back to deterministic
      fetch("/.netlify/functions/review-ai", {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
      }).then(function(r){
        if (!r.ok) throw new Error("no function");
        return r.json();
      }).then(function(j){
        var text = (j && j.text) ? String(j.text).trim() : "";
        if (!text) throw new Error("empty");
        finish(text, true);
      }).catch(function(){
        finish(writeShortReview({name:body.restaurant,experience:body.experience,highlight:body.highlight,keywords:body.keywords,details:details}), false);
      });
    }

    function attachCopyBehavior(){
      var btn=qs("#copyBtn"); if (!btn) return;
      var label=btn.querySelector(".btn-label"); var original=label.textContent;
      btn.addEventListener("click", function(){
        var txt = (qs("#reviewText") && qs("#reviewText").value) ? qs("#reviewText").value.trim() : "";
        if (!txt) return;
        copyText(txt).then(function(){
          label.textContent="Copied"; qs("#sr-live").textContent="Copied to clipboard";
          setTimeout(function(){ label.textContent=original; }, 2000);
        });
      });
    }

    /* ======== FLOW ======== */
    function setExperience(xp){
      state.experience = xp;
      if (xp==="Not great"){
        qs("#experience").classList.add("hidden");
        qs("#negative").classList.remove("hidden"); qs("#negative").setAttribute("aria-hidden","false");
      } else {
        qs("#experience").classList.add("hidden");
        qs("#positive").classList.remove("hidden"); qs("#positive").setAttribute("aria-hidden","false");
      }
    }
    function sendNegative(){
      var btn=qs("#sendNegative"); var status=qs("#negStatus");
      btn.disabled=true; status.textContent="Sending‚Ä¶";
      var payload = {
        tenantId: state.tenant.slug,
        restaurantName: state.tenant.name,
        timestampISO: new Date().toISOString(),
        selection:{ experience:"Not great" },
        answers: state.neg,
        userAgent: navigator.userAgent
      };
      fetch("/.netlify/functions/feedback", {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload), keepalive:true
      })["catch"](function(){});
      status.textContent="";
      var form=qs("#negForm"); var done=qs("#negDone");
      form.classList.add("opacity-0","translate-y-2");
      setTimeout(function(){ form.classList.add("hidden"); done.classList.remove("hidden"); }, 220);
    }

    /* ======== DEFAULT TENANT (fallback) ======== */
    var DEFAULT_TENANT = {
      slug: "sahara",
      name: "Sahara",
      brand: { primary: "#b91c1c" },
      google: {
        mapsUrl: "https://www.google.com/maps/place/Sahara+Restaurant/@40.5000681,-74.4567202,17z/data=!4m8!3m7!1s0x89c3c6ff3e35125b:0xc9ebce3f3d21e043!8m2!3d40.5000681!4d-74.4541453!9m1!1b1!16s%2Fg%2F1tczldzb?hl=en-US&entry=ttu&g_ep=EgoyMDI1MDgyNC4wIKXMDSoASAFQAw%3D%3D"
      },
      keywords: [
        "chicken kebab","adana kebab","lamb chops","hummus","baba ghanoush",
        "falafel","tabouleh","baklava","salmon","shrimp","tilapia",
        "roasted eggplant","couscous","shepherd‚Äôs salad","pita","turkish coffee"
      ],
      highlightOptions: ["Food","Service","Atmosphere","Authenticity"],
      negativeQuestions: {
        diningModes: ["Dine in","Take out","Delivery"],
        meals: ["Breakfast","Brunch","Lunch","Dinner","Other"],
        spendRanges: ["$1‚Äì10","$10‚Äì20","$20‚Äì30","$30‚Äì50","$50‚Äì100","$100+"]
      }
    };

    /* ======== INIT ======== */
    function init(){
      var cfg=null;
      function afterLoad(){
        if (!cfg) cfg = DEFAULT_TENANT;
        state.tenant = cfg;

        setBrand(cfg.brand && cfg.brand.primary ? cfg.brand.primary : "#b91c1c");
        qs("#restName").textContent = cfg.name || "Your Restaurant";
        var gURL = googleUrl(cfg.google || null);
        var glTop = qs("#googleTopLink"); var tipTop=qs("#googleTipTop");
        if (gURL) { glTop.href = gURL; tipTop.textContent = ""; }
        else { glTop.removeAttribute("href"); tipTop.textContent = "Ask your provider to set a Google Maps URL or Place ID."; }

        buildNegativeUI();

        qsa("[data-exp]").forEach(function(b){
          b.addEventListener("click", function(){ setExperience(b.getAttribute("data-exp")); });
        });

        var reveal = qs("#revealAi");
        if (reveal) reveal.addEventListener("click", function(){
          qs("#craftWrap").classList.remove("hidden");
          state.wizStep = 0;
          state.selectedTags.clear();
          state.highlight = null;
          state.posDetails = { veg:null, diet:[], parking:null, kids:[], access:[] };
          renderWizardStep();
        });

        qs("#wizNext").addEventListener("click", wizardNext);
        qs("#wizBack").addEventListener("click", wizardBack);
        qs("#wizSkipAll").addEventListener("click", wizardSkipAll);

        qs("#sendNegative").addEventListener("click", sendNegative);
      }

      if (window.fetch){
        fetch(DATA_URL, {cache:"no-store"}).then(function(res){
          if (res.ok) return res.json();
          return null;
        }).then(function(json){
          cfg = json;
          afterLoad();
        })["catch"](function(){
          cfg = null; afterLoad();
        });
      } else {
        cfg = null; afterLoad();
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
