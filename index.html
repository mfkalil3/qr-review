<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Share Your Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand: #b91c1c }
    .brand-bg  { background-color: var(--brand) }
    .brand-txt { color: var(--brand) }
    .brand-ring{ --tw-ring-color: var(--brand) }
    .smooth    { transition: all 220ms ease }
    .card      { box-shadow: 0 10px 30px rgba(0,0,0,.06) }
    .chip {
      display:inline-flex; align-items:center; gap:.4rem;
      border:1.5px solid #e2e8f0; padding:.44rem .8rem; border-radius:9999px;
      font-size:.875rem; background:#fff;
    }
    .chip:hover { background:#f8fafc }
    .chip[aria-pressed="true"] { color:#fff; background:var(--brand); border-color:transparent }
    details > summary::-webkit-details-marker { display:none }
    /* Simple step transitions */
    .step-enter { opacity: 0; transform: translateY(6px); }
    .step-enter-active { opacity: 1; transform: translateY(0); transition: all 260ms ease; }
    .step-leave { opacity: 1; transform: translateY(0); }
    .step-leave-active { opacity: 0; transform: translateY(-6px); transition: all 200ms ease; }
    @media (prefers-reduced-motion: reduce) {
      .smooth, .step-enter-active, .step-leave-active { transition: none !important; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-200 text-slate-800 antialiased">
  <main class="mx-auto max-w-3xl px-4 py-10">
    <section class="mx-auto max-w-2xl rounded-2xl bg-white card ring-1 ring-black/5 overflow-hidden">
      <!-- Header -->
      <header class="p-6 sm:p-8 border-b border-slate-100">
        <h1 id="title" class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Share your experience at <span id="restName" class="brand-txt">Sahara</span>
        </h1>
      </header>

      <!-- Body -->
      <div class="p-6 sm:p-8 space-y-10">

        <!-- STEP 1 ‚Äî EXPERIENCE (kept for layout parity; we immediately show positive path buttons) -->
        <section aria-hidden="true" class="hidden"></section>

        <!-- POSITIVE PATH BUTTONS -->
        <section id="positive" aria-hidden="false">
          <div id="topRow" class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-center">
            <a id="googleTopLink" target="_blank" rel="noopener noreferrer"
               class="inline-flex items-center justify-center h-[52px] rounded-lg px-4 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth disabled:opacity-40 disabled:pointer-events-none"
               aria-label="Post on Google">
              ‚≠ê <span class="ml-2" id="googleTopText">Post on Google</span>
            </a>

            <button id="revealAi" type="button"
                    class="inline-flex items-center justify-center h-[52px] rounded-lg px-4 border border-[var(--brand)] text-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth"
                    aria-label="Help me with AI">
              ‚ú® Help me with AI
            </button>
          </div>
          <p id="googleTipTop" class="mt-2 text-sm text-slate-500"></p>

          <!-- AI WIZARD -->
          <div id="craftWrap" class="hidden mt-6">
            <div id="wizard" class="rounded-xl border border-slate-200 p-5 sm:p-6">
              <div class="flex items-start justify-between">
                <div>
                  <h2 class="text-xl sm:text-2xl font-semibold">Write your review</h2>
                  <p id="wizSub" class="mt-1 text-sm text-slate-600">Quick questions. Skip anytime.</p>
                </div>
                <div class="text-right">
                  <div id="wizProgress" class="text-sm text-slate-500">Step 1</div>
                  <div id="wizDots" class="mt-2 flex items-center gap-1.5" aria-hidden="true"></div>
                </div>
              </div>

              <div id="wizContent" class="mt-5 step-enter step-enter-active"><!-- dynamic step content --></div>

              <div class="mt-6 flex flex-wrap gap-3 justify-between">
                <div class="flex gap-3">
                  <button id="wizBack" type="button" class="rounded-lg px-4 py-2 border border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 smooth" aria-label="Back">Back</button>
                </div>
                <div class="flex gap-3">
                  <button id="wizSkipAll" type="button" class="rounded-lg px-4 py-2 border border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 smooth invisible" aria-label="Skip to review">Skip to review</button>
                  <button id="wizNext" type="button" class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Next">Next</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- NEGATIVE PATH (not used in this simplified view) -->
        <section id="negative" class="hidden" aria-hidden="true"></section>
      </div>
    </section>
  </main>

  <!-- aria-live region -->
  <div id="sr-live" class="sr-only" aria-live="polite"></div>

  <script>
    /* ========= ROUTE ‚Üí TENANT KEY ========= */
    function getTenantKey(){
      const qs = new URLSearchParams(window.location.search);
      const qid = qs.get("id");
      if (qid) return String(qid).trim().toLowerCase();
      const path = window.location.pathname.replace(/^\/+/, "");
      if (path.indexOf("r/") === 0){
        const parts = path.split("/");
        if (parts[1]) return String(parts[1]).trim().toLowerCase();
      }
      return "sahara"; // default for testing
    }

    // Build dataset URL dynamically (DB-backed)
    const DATA_URL = "/.netlify/functions/get-tenant?slug=" + encodeURIComponent(getTenantKey());

    /* ========= OPTIONAL: browser-only AI key (leave empty in production) ========= */
    const TEST_GROQ_KEY = ""; // add gsk_... only for quick local tests

    /* ========= UTILITIES ========= */
    const qs = (s, r)=> (r||document).querySelector(s);
    const qsa = (s, r)=> Array.prototype.slice.call((r||document).querySelectorAll(s));
    function setBrand(hex){ document.documentElement.style.setProperty("--brand", hex || "#b91c1c"); }
    function copyText(t){
      if (navigator.clipboard?.writeText) return navigator.clipboard.writeText(t);
      const ta=document.createElement("textarea"); ta.value=t; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
      return Promise.resolve();
    }
    function googleUrl(google){
      if (google?.mapsUrl) return google.mapsUrl;
      if (google?.placeId) return "https://search.google.com/local/writereview?placeid="+encodeURIComponent(google.placeId);
      return "";
    }

    /* ========= ANIM HELPERS ========= */
    function swapContent(container, newHTML, after){
      container.classList.remove('step-enter','step-enter-active');
      container.classList.add('step-leave');
      void container.offsetWidth;
      container.classList.add('step-leave-active');
      setTimeout(function(){
        container.innerHTML = newHTML;
        if (typeof after === 'function') after();
        container.classList.remove('step-leave','step-leave-active');
        container.classList.add('step-enter');
        void container.offsetWidth;
        container.classList.add('step-enter-active');
        setTimeout(()=>container.classList.remove('step-enter','step-enter-active'), 280);
      }, 200);
    }

    /* ========= TYPEWRITER ========= */
    function typeInto(el, text, speed=14){
      el.value = "";
      let i = 0;
      (function tick(){
        if (i <= text.length){
          el.value = text.slice(0, i++);
          setTimeout(tick, speed);
        }
      })();
    }

    /* ========= FALLBACK REVIEW ========= */
    function writeShortReview(args) {
      const name = args.name || "this restaurant";
      const exp = args.experience || "Good";
      const highlight = args.highlight || "";
      const keywords = args.keywords || [];
      const details = args.details || "";

      const openersGood = ["I stopped by","I visited","A quick note about"];
      const openersEx   = ["Dinner at","An evening at","My visit to"];
      const opener = (exp === "Excellent" ? openersEx : openersGood)[Math.floor(Math.random()*openersEx.length)];

      const k = keywords.slice(0,3);
      const dishLine = k.length ? (" The " + k.join(", ") + (k.length===1?" was":" were") + " tasty.") : "";
      const hlMap = {
        "Food":" Flavors really shined. üçΩÔ∏è",
        "Service":" Friendly, well-timed service. ü§ù",
        "Atmosphere":" Calm, welcoming vibe. üïØÔ∏è",
        "Authenticity":" Felt true to the cuisine. üåø"
      };
      const hl = hlMap[highlight] || "";
      const extra = details ? (" " + details.trim()) : "";
      const closer = (exp==="Excellent") ? " Highly recommended." : " I‚Äôd return.";
      return `${opener} ${name} was ${exp.toLowerCase()}.${dishLine}${hl}${extra}${closer}`;
    }
    function detailsSummary(d){
      const parts=[];
      if (d.veg) parts.push("Vegetarian options: " + d.veg);
      if (d.diet?.length) parts.push("Dietary: " + d.diet.join(", "));
      if (d.parking) parts.push("Parking: " + d.parking);
      if (d.kids?.length) parts.push("Kid-friendliness: " + d.kids.join(", "));
      if (d.access?.length) parts.push("Accessibility: " + d.access.join(", "));
      return parts.join(" | ");
    }

    /* ========= STATE ========= */
    const state = {
      tenant: null,
      experience: "Good",
      highlight: null,
      selectedTags: new Set(),
      showAllKw: false,
      posDetails: { veg:null, diet:[], parking:null, kids:[], access:[], _extra:"" },
      neg: { dining:null, meal:null, spend:null, feedback:"" },
      wizStep: 0
    };

    /* ========= CHIPS ========= */
    function makeChip(text, pressed, onClick){
      const b=document.createElement("button");
      b.type="button"; b.className="chip smooth"; b.setAttribute("aria-pressed", pressed?"true":"false");
      b.textContent = text;
      b.addEventListener("click", onClick || function(){});
      return b;
    }

    // Defensive renderer for keywords (NO 3-limit)
    function renderKeywords(){
      const wrap = qs("#kwWrap");
      if (!wrap) return;
      wrap.innerHTML = "";

      const listRaw = state.tenant && state.tenant.keywords;
      const list = Array.isArray(listRaw) ? listRaw : [];

      const toggle = qs("#kwToggle");
      if (!list.length) {
        if (toggle) toggle.classList.add("hidden");
        const emptyNote = document.createElement("p");
        emptyNote.className = "text-sm text-slate-500";
        emptyNote.textContent = "No keywords found for this restaurant.";
        wrap.appendChild(emptyNote);
        return;
      }

      const max = state.showAllKw ? list.length : Math.min(16, list.length);
      for (let i = 0; i < max; i++) {
        const k = list[i];
        const pressed = state.selectedTags.has(k);
        wrap.appendChild(makeChip(k, pressed, function(){
          const on = state.selectedTags.has(k);
          if (on) state.selectedTags.delete(k); else state.selectedTags.add(k);
          renderKeywords();
        }));
      }

      if (toggle) {
        if (list.length <= 16) {
          toggle.classList.add("hidden");
        } else {
          toggle.classList.remove("hidden");
          toggle.textContent = state.showAllKw ? "See fewer" : "See more";
        }
      }
    }

    function renderHighlights(){
      const wrap=qs("#hlWrap"); if (!wrap) return; wrap.innerHTML="";
      const opts = state.tenant?.highlightOptions || ["Food","Service","Atmosphere","Authenticity"];
      const emojis = { Food:"üçΩÔ∏è", Service:"ü§ù", Atmosphere:"üïØÔ∏è", Authenticity:"üåø" };
      opts.forEach(h=>{
        const pressed = state.highlight===h;
        wrap.appendChild(makeChip(`${emojis[h]||""} ${h}`, pressed, ()=>{
          state.highlight = (state.highlight===h) ? null : h;
          renderHighlights();
        }));
      });
    }

    function chipGroup(sel, options, multi, getter, setter){
      const wrap=qs(sel); if (!wrap) return; wrap.innerHTML="";
      const current = getter();
      const selSet = new Set(Array.isArray(current) ? current : (current ? [current] : []));
      options.forEach(opt=>{
        wrap.appendChild(makeChip(opt, selSet.has(opt), ()=>{
          const on = selSet.has(opt);
          if (multi){ if (on) selSet.delete(opt); else selSet.add(opt); setter(Array.from(selSet)); }
          else { selSet.clear(); selSet.add(opt); setter(opt); }
          chipGroup(sel, options, multi, getter, setter);
        }));
      });
    }

    /* ========= DOTS ========= */
    // 1: keywords, 2: visit+parking, 3: kids+access, 4: standout, 5: vegetarian, 6: extra details, 7: review
    const WIZ_IDS = ["kw","visit","family_access","standout","veg","details","review"];
    function renderDots(){
      const dots = qs("#wizDots"); if (!dots) return; dots.innerHTML="";
      for (let i=0;i<WIZ_IDS.length;i++){
        const d=document.createElement("div");
        const base="h-1.5 w-4 rounded-full smooth";
        let cls = i < state.wizStep ? "bg-[color:rgba(185,28,28,.35)]" : "bg-slate-200";
        if (i === state.wizStep) cls = "bg-[var(--brand)]";
        d.className = base+" "+cls;
        dots.appendChild(d);
      }
    }

    /* ========= WIZARD ========= */
    function renderWizardStep(){
      const id = WIZ_IDS[state.wizStep];
      const total = WIZ_IDS.length;
      qs("#wizProgress").textContent = "Step " + (state.wizStep+1) + " of " + total;

      const c = qs("#wizContent");
      const back = qs("#wizBack");
      const next = qs("#wizNext");
      const skipAll = qs("#wizSkipAll");
      const sub = qs("#wizSub");

      back.disabled = (state.wizStep === 0);
      // show Skip to review only after Q2 (index >= 2)
      if (state.wizStep < 2) skipAll.classList.add("invisible");
      else skipAll.classList.remove("invisible");

      sub.classList.remove("hidden");
      next.classList.remove("hidden");

      if (id === "kw"){
        const html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Pick keywords</p>'+
            '<div class="mt-3 flex items-center justify-between">'+
              '<div id="kwWrap" class="flex flex-wrap gap-2"></div>'+
              '<button id="kwToggle" type="button" class="text-sm text-slate-600 hover:text-slate-800 focus:outline-none focus-visible:ring-2 brand-ring rounded-md px-2 py-1 smooth">See more</button>'+
            '</div>'+
          '</div>';
        swapContent(c, html, ()=>{
          renderKeywords();
          const t=qs("#kwToggle"); if(t){ t.addEventListener("click", ()=>{ state.showAllKw=!state.showAllKw; renderKeywords(); }); }
        });
      }

      else if (id === "visit"){
        const html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700 mb-3">Visit type & Parking</p>'+
            '<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">'+
              '<div>'+
                '<p class="text-sm text-slate-700">Visit type</p>'+
                '<div id="q-visit" class="mt-2 flex flex-wrap gap-2"></div>'+
              '</div>'+
              '<div>'+
                '<p class="text-sm text-slate-700">Parking</p>'+
                '<div id="q-parking" class="mt-2 flex flex-wrap gap-2"></div>'+
              '</div>'+
            '</div>'+
          '</div>';
        swapContent(c, html, ()=>{
          chipGroup("#q-visit", ["Dine-in","Takeout","Delivery"], false, ()=>state.neg.dining, v=>state.neg.dining=v);
          chipGroup("#q-parking", ["Street","Lot","Valet","None / not sure"], false, ()=>state.posDetails.parking, v=>state.posDetails.parking=v);
        });
      }

      else if (id === "family_access"){
        const html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700 mb-3">Family & Accessibility</p>'+
            '<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">'+
              '<div>'+
                '<p class="text-sm text-slate-700">Kid-friendliness</p>'+
                '<div id="q-kids" class="mt-2 flex flex-wrap gap-2"></div>'+
              '</div>'+
              '<div>'+
                '<p class="text-sm text-slate-700">Wheelchair accessibility</p>'+
                '<div id="q-access" class="mt-2 flex flex-wrap gap-2"></div>'+
              '</div>'+
            '</div>'+
          '</div>';
        swapContent(c, html, ()=>{
          chipGroup("#q-kids",
            ["Good for kids","High chairs","Kids menu","Not kid-focused"],
            true, ()=>state.posDetails.kids, v=>state.posDetails.kids=v);
          chipGroup("#q-access",
            ["Step-free entrance","Accessible restroom","Good aisle spacing","Not sure"],
            true, ()=>state.posDetails.access, v=>state.posDetails.access=v);
        });
      }

      else if (id === "standout"){
        const html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">What stood out the most?</p>'+
            '<div id="hlWrap" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';
        swapContent(c, html, ()=> renderHighlights());
      }

      else if (id === "veg"){
        const html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Vegetarian options?</p>'+
            '<div id="pos-veg" class="mt-3 flex flex-wrap gap-2"></div>'+
          '</div>';
        swapContent(c, html, ()=>{
          chipGroup("#pos-veg", ["Yes","No","Not sure"], false, ()=>state.posDetails.veg, v=>state.posDetails.veg=v);
        });
      }

      else if (id === "details"){
        const html =
          '<div>'+
            '<p class="text-sm font-medium text-slate-700">Anything else to add?</p>'+
            '<textarea id="extraDetails" rows="4" class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-3" placeholder="Add any short details you want included in the review‚Ä¶"></textarea>'+
          '</div>';
        swapContent(c, html, ()=>{
          const ed=qs("#extraDetails");
          if (ed) ed.addEventListener("input", e=>{
            state.posDetails._extra = e.target.value || "";
          });
        });
      }

      else if (id === "review"){
        sub.classList.add("hidden");
        next.classList.add("hidden");
        skipAll.classList.add("invisible");
        const html =
          '<div>'+
            '<div class="flex items-center justify-between">'+
              '<label for="reviewText" class="text-sm font-medium text-slate-700">Your review</label>'+
              '<label class="inline-flex items-center gap-2 cursor-pointer">'+
                '<input id="editToggle" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-[var(--brand)] focus:ring-[var(--brand)]" checked />'+
                '<span class="text-sm text-slate-700">Enable editing</span>'+
              '</label>'+
            '</div>'+
            '<textarea id="reviewText" rows="5" class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-4 text-[15px] leading-6" aria-describedby="copyHelp" placeholder="Generating‚Ä¶"></textarea>'+
            '<p id="copyHelp" class="mt-2 text-sm text-slate-500">Copy and paste to Google when ready.</p>'+
            '<div class="mt-3 flex flex-wrap items-center gap-3">'+
              '<button id="aiBtn" type="button" class="rounded-lg px-4 py-2 border border-[var(--brand)] text-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth">‚ú® Polish with AI</button>'+
              '<button id="copyBtn" type="button" disabled class="rounded-lg px-4 py-2 text-white bg-slate-700 disabled:opacity-40 disabled:pointer-events-none hover:brightness-95 focus:outline-none focus-visible:ring-2 smooth"><span class="btn-label">Copy</span></button>'+
              '<span id="aiStatus" class="text-sm text-slate-600" aria-live="polite"></span>'+
            '</div>'+
          '</div>';
        swapContent(c, html, ()=>{
          const ed=qs("#editToggle");
          ed.addEventListener("change", ()=>{
            const ta=qs("#reviewText");
            if (ed.checked) ta.removeAttribute("readonly"); else ta.setAttribute("readonly","");
          });
          attachCopyBehavior();
          generateReview();                              // auto-generate
          qs("#aiBtn").addEventListener("click", generateReview); // regenerate
        });
      }

      renderDots();
    }

    function wizardNext(){ if (state.wizStep < WIZ_IDS.length-1){ state.wizStep++; renderWizardStep(); } }
    function wizardBack(){ if (state.wizStep > 0){ state.wizStep--; renderWizardStep(); } }
    function wizardSkipAll(){ state.wizStep = WIZ_IDS.indexOf("review"); renderWizardStep(); }

    /* ========= AI (browser test / function) ========= */
    function callGroqDirect(payload){
      if (!TEST_GROQ_KEY) return Promise.reject(new Error("TEST_GROQ_KEY is empty"));
      const system = "You write polished restaurant reviews. Return ONLY one paragraph. 20‚Äì30 words, warm fine-dining tone, 1‚Äì2 tasteful emojis (üçΩÔ∏è ü§ù üïØÔ∏è üåø ‚ú® ‚ù§Ô∏è üëç). Mention the restaurant by name. Avoid headings, quotes, or preambles.";
      const user =
        "Restaurant: " + (payload.restaurant||"Unknown") + "\n" +
        "Experience: " + (payload.experience||"Good") + "\n" +
        "Highlight: " + (payload.highlight||"Food") + "\n" +
        "Keywords: " + ((payload.keywords||[]).slice(0,3).join(", ") || "‚Äî") + "\n" +
        "Optional details: " + (payload.extra||"‚Äî") + "\n\n" +
        "Write a single paragraph suitable to paste into Google.";
      return fetch("https://api.groq.com/openai/v1/chat/completions", {
        method:"POST",
        headers:{ "Authorization":"Bearer " + TEST_GROQ_KEY, "Content-Type":"application/json" },
        body: JSON.stringify({
          model: "meta-llama/llama-4-scout-17b-16e-instruct",
          temperature: 0.65,
          max_tokens: 140,
          messages: [{role:"system",content:system},{role:"user",content:user}]
        })
      }).then(resp=>{
        if (!resp.ok) return resp.text().then(t=>{ throw new Error("Groq HTTP " + resp.status + ": " + t.slice(0,150)); });
        return resp.json();
      }).then(data=>{
        return (data?.choices?.[0]?.message?.content || "").trim();
      });
    }

    function generateReview(){
      const status=qs("#aiStatus"); if (status) status.textContent="Polishing‚Ä¶";
      const details = (detailsSummary(state.posDetails) + (state.posDetails?._extra ? (" " + state.posDetails._extra) : "")).trim();
      const body = {
        restaurant: state.tenant?.name || "This restaurant",
        experience: state.experience || "Good",
        highlight: state.highlight || "Food",
        keywords: Array.from(state.selectedTags),
        extra: details
      };
      function done(text, usedAI){
        const ta = qs("#reviewText");
        if (ta) typeInto(ta, text, 12);  // typewriter
        qs("#copyBtn").removeAttribute("disabled");
        if (status) status.textContent = usedAI ? "AI suggestion applied." : "Draft created.";
      }
      if (TEST_GROQ_KEY){
        return callGroqDirect(body).then(text=>{
          if (!text) throw new Error("empty");
          done(text, true);
        }).catch(()=>{
          done(writeShortReview({name:body.restaurant,experience:body.experience,highlight:body.highlight,keywords:body.keywords,details:details}), false);
        });
      } else {
        return fetch("/.netlify/functions/review-ai", {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
        }).then(r=>{
          if (!r.ok) throw new Error("no function");
          return r.json();
        }).then(j=>{
          const text = (j && j.text) ? String(j.text).trim() : "";
          if (!text) throw new Error("empty");
          done(text, true);
        }).catch(()=>{
          done(writeShortReview({name:body.restaurant,experience:body.experience,highlight:body.highlight,keywords:body.keywords,details:details}), false);
        });
      }
    }

    function attachCopyBehavior(){
      const btn=qs("#copyBtn"); if (!btn) return;
      const label=btn.querySelector(".btn-label"); const original=label.textContent;
      btn.addEventListener("click", ()=>{
        const txt = (qs("#reviewText")?.value || "").trim();
        if (!txt) return;
        copyText(txt).then(()=>{
          label.textContent="Copied"; qs("#sr-live").textContent="Copied to clipboard";
          setTimeout(()=>{ label.textContent=original; }, 2000);
        });
      });
    }

    /* ========= NOT FOUND RENDER ========= */
    function renderNotFound(slug){
      setBrand("#6b7280");
      qs("#restName").textContent = slug ? `Not found: ${slug}` : "Not found";
      const holder = document.createElement("div");
      holder.className = "px-6 pb-8";
      holder.innerHTML = `<p class="text-slate-600">We couldn‚Äôt find that restaurant. Check the link (e.g. <code>/r/sahara</code>).</p>`;
      document.querySelector("main .card")?.appendChild(holder);
      // Hide top row / wizard
      qs("#positive").classList.add("hidden");
    }

    /* ========= INIT ========= */
    function init(){
      const slug = getTenantKey();

      // Fetch tenant from DB-backed function
      fetch(DATA_URL, { cache: "no-store" })
        .then(res => {
          if (res.status === 404) return { notFound: true };
          if (!res.ok) throw new Error("fetch failed");
          return res.json();
        })
        .then(json => {
          if (json && json.notFound) { renderNotFound(slug); return; }
          const cfg = (json && json.tenant) ? json.tenant : null;
          if (!cfg) { renderNotFound(slug); return; }

          state.tenant = cfg;
          setBrand(cfg.brand?.primary || "#b91c1c");
          qs("#restName").textContent = cfg.name || "Your Restaurant";

          const gURL = googleUrl(cfg.google || null);
          const glTop = qs("#googleTopLink"); const tipTop=qs("#googleTipTop"); const glTxt=qs("#googleTopText");
          if (gURL) { glTop.href = gURL; glTxt.textContent = `Post on Google`; tipTop.textContent=""; }
          else { glTop.removeAttribute("href"); glTop.setAttribute("aria-disabled","true"); glTxt.textContent="Google link not set"; tipTop.textContent="Ask your provider to set a Google Maps URL or Place ID."; }

          // Reveal AI: hide button and center Google
          const reveal = qs("#revealAi");
          if (reveal) reveal.addEventListener("click", ()=>{
            reveal.classList.add("hidden");
            const row = qs("#topRow");
            if (row){
              row.classList.remove("sm:grid-cols-2");
              row.classList.add("sm:grid-cols-1","justify-items-center");
            }
            qs("#craftWrap").classList.remove("hidden");
            state.wizStep = 0;
            state.selectedTags.clear();
            state.highlight = null;
            state.posDetails = { veg:null, diet:[], parking:null, kids:[], access:[], _extra: state.posDetails?._extra || "" };
            renderWizardStep();
          });

          // Wizard nav
          qs("#wizNext").addEventListener("click", wizardNext);
          qs("#wizBack").addEventListener("click", wizardBack);
          qs("#wizSkipAll").addEventListener("click", wizardSkipAll);
        })
        .catch(() => {
          // offline / function error fallback ‚Äì minimal
          renderNotFound(slug);
        });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
