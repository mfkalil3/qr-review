<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Share Your Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand: #b91c1c }
    .brand-bg  { background-color: var(--brand) }
    .brand-txt { color: var(--brand) }
    .brand-ring{ --tw-ring-color: var(--brand) }
    .smooth    { transition: all 220ms ease }
    .card      { box-shadow: 0 12px 40px rgba(0,0,0,.08) }
    .chip {
      display:inline-flex; align-items:center; gap:.45rem;
      border:1.5px solid #e2e8f0; padding:.44rem .85rem; border-radius:9999px;
      font-size:.9rem; background:#fff; line-height:1;
    }
    .chip:hover { background:#f8fafc }
    .chip[aria-pressed="true"] { color:#fff; background:var(--brand); border-color:transparent }
    details > summary::-webkit-details-marker { display:none }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-200 text-slate-800 antialiased">
  <main class="mx-auto max-w-3xl px-4 py-10">
    <section class="mx-auto max-w-2xl rounded-2xl bg-white card ring-1 ring-black/5 overflow-hidden">
      <!-- Header -->
      <header class="p-6 sm:p-8 border-b border-slate-100">
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Share your experience at <span id="restName" class="brand-txt">Your Restaurant</span>
        </h1>
      </header>

      <!-- Body -->
      <div class="p-6 sm:p-8 space-y-10">

        <!-- STEP 1 ‚Äî EXPERIENCE -->
        <section id="experience" aria-labelledby="exp-title">
          <h2 id="exp-title" class="text-xl sm:text-2xl font-semibold">How was your experience today?</h2>
          <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <button type="button" data-exp="Excellent" class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Excellent">
              <div class="text-2xl">ü§©</div>
              <div class="mt-1 text-base font-medium">Excellent</div>
              <p class="text-sm text-slate-500">Everything sang.</p>
            </button>
            <button type="button" data-exp="Good" class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Good">
              <div class="text-2xl">üôÇ</div>
              <div class="mt-1 text-base font-medium">Good</div>
              <p class="text-sm text-slate-500">Worth sharing.</p>
            </button>
            <button type="button" data-exp="Not great" class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth" aria-label="Not great">
              <div class="text-2xl">üòï</div>
              <div class="mt-1 text-base font-medium">Not great</div>
              <p class="text-sm text-slate-500">Tell us why.</p>
            </button>
          </div>
        </section>

        <!-- POSITIVE PATH -->
        <section id="positive" class="hidden" aria-hidden="true">
          <!-- Sticky bar: Google first, then small AI help -->
          <div class="sticky top-0 z-10 -mx-6 sm:-mx-8 px-6 sm:px-8 py-3 bg-white/85 backdrop-blur border-b border-slate-100">
            <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
              <a id="googleTopLink" target="_blank" rel="noopener noreferrer"
                 class="inline-flex w-full sm:flex-1 items-center justify-center rounded-lg px-4 py-3 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth disabled:opacity-40 disabled:pointer-events-none">
                ‚≠ê <span class="ml-2">Open Google to post</span>
              </a>
              <button id="revealAi" type="button"
                      class="inline-flex sm:w-auto items-center justify-center rounded-lg px-4 py-3 border border-[var(--brand)] text-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth">
                ‚ú® Help me with AI
              </button>
            </div>
            <p id="googleTipTop" class="mt-2 text-sm text-slate-500"></p>
          </div>

          <!-- CRAFT (hidden until AI help is clicked) -->
          <div id="craftWrap" class="hidden mt-6">
            <h2 class="text-xl sm:text-2xl font-semibold">Craft your review</h2>
            <p class="mt-1 text-sm text-slate-600">Write a short paragraph you can paste into Google. AI is optional.</p>

            <!-- Keywords -->
            <div class="mt-4">
              <div class="flex items-center justify-between">
                <p class="text-sm font-medium text-slate-700">Pick a few keywords</p>
                <button id="kwToggle" type="button" class="text-sm text-slate-600 hover:text-slate-800 focus:outline-none focus-visible:ring-2 brand-ring rounded-md px-2 py-1 smooth">See more</button>
              </div>
              <p class="mt-1 text-sm text-slate-500">Choose up to 3.</p>
              <div id="kwWrap" class="mt-3 flex flex-wrap gap-2"></div>
            </div>

            <!-- Highlight -->
            <div class="mt-6">
              <p class="text-sm font-medium text-slate-700">What stood out the most?</p>
              <div id="hlWrap" class="mt-3 flex flex-wrap gap-2"></div>
            </div>

            <!-- Review -->
            <div class="mt-6">
              <div class="flex items-center justify-between">
                <label for="reviewText" class="text-sm font-medium text-slate-700">Your review</label>
                <label class="inline-flex items-center gap-2 cursor-pointer">
                  <input id="editToggle" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-[var(--brand)] focus:ring-[var(--brand)]" />
                  <span class="text-sm text-slate-700">Enable editing</span>
                </label>
              </div>
              <textarea id="reviewText" rows="5" readonly placeholder="Click 'Write review' (no AI) or 'Polish with AI' to generate a short paragraph (under 60 words)."
                class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-4 text-[15px] leading-6"
                aria-describedby="copyHelp"></textarea>
              <p id="copyHelp" class="mt-2 text-sm text-slate-500">Copy and paste to Google when ready.</p>

              <div class="mt-3 flex flex-wrap items-center gap-3">
                <button id="writeBtn" type="button" class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth">Write review</button>
                <button id="aiBtn" type="button" class="rounded-lg px-4 py-2 border border-[var(--brand)] text-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth">‚ú® Polish with AI</button>

                <button id="copyBtn" type="button" disabled class="rounded-lg px-4 py-2 text-white bg-slate-700 disabled:opacity-40 disabled:pointer-events-none hover:brightness-95 focus:outline-none focus-visible:ring-2 smooth"><span class="btn-label">Copy</span></button>
                <span id="copyStatus" class="text-sm text-slate-600" aria-live="polite"></span>
              </div>
              <div id="aiStatus" class="mt-2 text-sm text-slate-600" aria-live="polite"></div>
            </div>

            <!-- Optional details -->
            <div class="mt-8">
              <p class="text-sm font-medium text-slate-700">Add more details to help others</p>
              <div class="mt-3 space-y-3">
                <details class="rounded-lg border border-slate-200 px-4 py-3">
                  <summary class="cursor-pointer select-none font-medium">Vegetarian options</summary>
                  <div class="mt-3 flex flex-wrap gap-2" id="pos-veg"></div>
                </details>
                <details class="rounded-lg border border-slate-200 px-4 py-3">
                  <summary class="cursor-pointer select-none font-medium">Dietary restrictions</summary>
                  <div class="mt-3 flex flex-wrap gap-2" id="pos-diet"></div>
                </details>
                <details class="rounded-lg border border-slate-200 px-4 py-3">
                  <summary class="cursor-pointer select-none font-medium">Parking</summary>
                  <div class="mt-3 flex flex-wrap gap-2" id="pos-parking"></div>
                </details>
                <details class="rounded-lg border border-slate-200 px-4 py-3">
                  <summary class="cursor-pointer select-none font-medium">Kid-friendliness</summary>
                  <div class="mt-3 flex flex-wrap gap-2" id="pos-kids"></div>
                </details>
                <details class="rounded-lg border border-slate-200 px-4 py-3">
                  <summary class="cursor-pointer select-none font-medium">Wheelchair accessibility</summary>
                  <div class="mt-3 flex flex-wrap gap-2" id="pos-access"></div>
                </details>
              </div>
            </div>
          </div>
        </section>

        <!-- NEGATIVE PATH -->
        <section id="negative" class="hidden" aria-hidden="true">
          <div id="negForm">
            <div class="text-center">
              <div class="text-4xl">üôè</div>
              <h2 class="mt-3 text-xl sm:text-2xl font-semibold">Thank you for your honesty.</h2>
              <p class="mt-2 text-slate-600">A few quick questions help the team improve.</p>
            </div>

            <div class="mt-6 space-y-6">
              <div>
                <p class="text-sm font-medium text-slate-700">Did you dine in, take out, or get delivery?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-dining"></div>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-700">What did you get?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-meal"></div>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-700">How much did you spend per person?</p>
                <div class="mt-3 flex flex-wrap gap-2" id="q-spend"></div>
              </div>
              <div>
                <label for="negFeedback" class="text-sm font-medium text-slate-700">Your feedback (optional)</label>
                <textarea id="negFeedback" rows="4" class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-3" placeholder="Write any details you'd like the manager to know‚Ä¶"></textarea>
              </div>
              <div class="flex items-center gap-3">
                <button id="sendNegative" type="button" class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth">Send</button>
                <span id="negStatus" class="text-sm text-slate-600" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <div id="negDone" class="hidden text-center py-10">
            <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-green-100 text-green-700 text-3xl">‚úì</div>
            <h3 class="mt-4 text-lg font-semibold">Your feedback was sent to the restaurant.</h3>
            <p class="mt-2 text-slate-600">We appreciate your time.</p>
          </div>
        </section>

      </div>
    </section>
  </main>

  <!-- aria-live region -->
  <div id="sr-live" class="sr-only" aria-live="polite"></div>

  <script>
    /***************
     * TEST-ONLY API KEY (do NOT use in production)
     ***************/
    // Paste a temporary Groq key here ONLY for local/testing.
    // Anyone can view it in page source. Rotate the key afterward.
    const TEST_GROQ_KEY = ""; // <-- paste gsk_... here for testing, or leave "" to use Netlify Function

    /***************
     * Utilities
     ***************/
    const qs  = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>[...r.querySelectorAll(s)];
    const setBrand = hex => document.documentElement.style.setProperty("--brand", hex || "#b91c1c");
    const copyText = async (t)=>{
      if (navigator.clipboard?.writeText) return navigator.clipboard.writeText(t);
      const ta=document.createElement("textarea"); ta.value=t; ta.style.position="fixed"; ta.style.left="-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
    };

    function googleUrl(google) {
      if (google?.mapsUrl) return google.mapsUrl;
      if (google?.placeId) return `https://search.google.com/local/writereview?placeid=${encodeURIComponent(google.placeId)}`;
      return "";
    }

    /***********************
     * Direct Groq (TEST ONLY)
     ***********************/
    async function callGroqDirect(payload) {
      if (!TEST_GROQ_KEY) throw new Error("TEST_GROQ_KEY is empty");
      const { restaurant, experience, highlight, keywords, extra } = payload;
      const system =
        "You write polished restaurant reviews. Return ONLY one paragraph. 40‚Äì60 words, warm fine-dining tone, 1‚Äì2 tasteful emojis (üçΩ ü§ù üåÜ üåç ‚ú® ‚ù§Ô∏è üëç). Mention the restaurant by name. Avoid extreme claims, headings, quotes, or preambles.";
      const user =
`Restaurant: ${restaurant || "Unknown"}
Experience: ${experience || "Good"}
Highlight: ${highlight || "Food"}
Keywords: ${(keywords || []).slice(0,3).join(", ") || "‚Äî"}
Optional details: ${extra || "‚Äî"}

Write a single paragraph suitable to paste into Google.`;

      const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": \`Bearer \${TEST_GROQ_KEY}\`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "meta-llama/llama-4-scout-17b-16e-instruct",
          temperature: 0.6,
          max_tokens: 140,
          messages: [
            { role: "system", content: system },
            { role: "user",   content: user }
          ]
        })
      });

      if (!resp.ok) {
        const txt = await resp.text().catch(() => "");
        throw new Error(\`Groq HTTP \${resp.status}: \${txt.slice(0,120)}\`);
      }
      const data = await resp.json();
      return (data?.choices?.[0]?.message?.content || "").trim();
    }

    /***********************
     * Deterministic writer
     ***********************/
    function writeShortReview({name, experience, highlight, keywords, details}) {
      // target under 60 words
      const tone = experience === "Excellent"
        ? ["Dinner at","An evening at","My visit to"][Math.floor(Math.random()*3)]
        : ["I stopped by","I visited","I had a meal at"][Math.floor(Math.random()*3)];
      const k = (keywords||[]).slice(0,3);
      const dish = k.length ? \` The \${k.join(", ")} \${k.length===1?"was":"were"} well prepared and full of flavor.\` : "";
      const hlMap = {
        "Food":" The kitchen‚Äôs attention to detail showed. üçΩ",
        "Service":" Service was attentive and well-timed. ü§ù",
        "Atmosphere":" The room felt calm and welcoming. üåÜ",
        "Authenticity":" Flavors felt thoughtful and true to the cuisine. üåç"
      };
      const extra = details ? \` \${details}.\` : "";
      const closer = experience === "Excellent" ? " Highly recommended." : " I‚Äôd happily return.";
      return \`\${tone} \${name} was \${experience.toLowerCase()}.\` + dish + (hlMap[highlight]||"") + extra + closer;
    }

    function detailsSummary(d) {
      const parts=[];
      if (d.veg) parts.push(\`Vegetarian options: \${d.veg}\`);
      if (d.diet?.length) parts.push(\`Dietary: \${d.diet.join(", ")}\`);
      if (d.parking) parts.push(\`Parking: \${d.parking}\`);
      if (d.kids?.length) parts.push(\`Kid-friendliness: \${d.kids.join(", ")}\`);
      if (d.access?.length) parts.push(\`Accessibility: \${d.access.join(", ")}\`);
      return parts.join(" | ");
    }

    /***************
     * State
     ***************/
    const state = {
      tenant: null,
      experience: null,
      highlight: null,
      selectedTags: new Set(),
      showAllKw: false,
      posDetails: { veg:null, diet:[], parking:null, kids:[], access:[] },
      neg: { dining:null, meal:null, spend:null, feedback:"" }
    };

    /*****************
     * Build UI bits
     *****************/
    function makeChip(text, pressed=false, onClick=()=>{}) {
      const b=document.createElement("button");
      b.type="button"; b.className="chip smooth"; b.setAttribute("aria-pressed", pressed?"true":"false");
      b.textContent = text;
      b.addEventListener("click", onClick);
      return b;
    }

    function renderKeywords() {
      const wrap=qs("#kwWrap"); wrap.innerHTML="";
      const list = state.tenant?.keywords || [];
      const max = state.showAllKw ? list.length : Math.min(16, list.length);
      list.slice(0,max).forEach(k=>{
        const pressed = state.selectedTags.has(k);
        wrap.appendChild(makeChip(k, pressed, ()=>{
          const on = state.selectedTags.has(k);
          if (!on && state.selectedTags.size>=3) return;
          on ? state.selectedTags.delete(k) : state.selectedTags.add(k);
          renderKeywords();
        }));
      });
      const t=qs("#kwToggle");
      if (list.length<=16) t.classList.add("hidden"); else { t.classList.remove("hidden"); t.textContent = state.showAllKw? "See fewer" : "See more"; }
    }

    function renderHighlights() {
      const opts = state.tenant?.highlightOptions || ["Food","Service","Atmosphere","Authenticity"];
      const wrap=qs("#hlWrap"); wrap.innerHTML="";
      opts.forEach(h=>{
        const pressed = state.highlight===h;
        wrap.appendChild(makeChip(h, pressed, ()=>{
          state.highlight = (state.highlight===h) ? null : h;
          renderHighlights();
        }));
      });
    }

    function chipGroup(el, options, multi=false, getter, setter) {
      const wrap=qs(el); wrap.innerHTML="";
      const sel=new Set(Array.isArray(getter())?getter():[getter()].filter(Boolean));
      options.forEach(opt=>{
        wrap.appendChild(makeChip(opt, sel.has(opt), ()=>{
          const isOn = sel.has(opt);
          if (multi) { isOn ? sel.delete(opt) : sel.add(opt); setter([...sel]); }
          else { sel.clear(); sel.add(opt); setter(opt); }
          chipGroup(el, options, multi, getter, setter);
        }));
      });
    }

    function buildPositiveDetailsUI() {
      chipGroup("#pos-veg", ["Yes","No","Not sure"], false, ()=>state.posDetails.veg, v=>state.posDetails.veg=v);
      chipGroup("#pos-diet", ["Gluten-free options","Vegan options","Halal options","Nut-aware","Dairy-free","Other"], true, ()=>state.posDetails.diet, v=>state.posDetails.diet=v);
      chipGroup("#pos-parking", ["Street","Lot","Valet","None / not sure"], false, ()=>state.posDetails.parking, v=>state.posDetails.parking=v);
      chipGroup("#pos-kids", ["Good for kids","High chairs","Kids menu","Not kid-focused"], true, ()=>state.posDetails.kids, v=>state.posDetails.kids=v);
      chipGroup("#pos-access", ["Step-free entrance","Accessible restroom","Good aisle spacing","Not sure"], true, ()=>state.posDetails.access, v=>state.posDetails.access=v);
    }

    function buildNegativeUI() {
      const nq = state.tenant?.negativeQuestions || {};
      chipGroup("#q-dining", nq.diningModes || ["Dine in","Take out","Delivery"], false, ()=>state.neg.dining, v=>state.neg.dining=v);
      chipGroup("#q-meal",   nq.meals || ["Breakfast","Brunch","Lunch","Dinner","Other"], false, ()=>state.neg.meal, v=>state.neg.meal=v);
      chipGroup("#q-spend",  nq.spendRanges || ["$1‚Äì10","$10‚Äì20","$20‚Äì30","$30‚Äì50","$50‚Äì100","$100+"], false, ()=>state.neg.spend, v=>state.neg.spend=v);
      qs("#negFeedback").addEventListener("input", e=> state.neg.feedback = e.target.value);
    }

    /**********************
     * Flow interactions
     **********************/
    function setExperience(xp){
      state.experience = xp;
      qs("#reviewText").value = "";
      qs("#copyBtn").setAttribute("disabled","true");
      qs("#copyStatus").textContent = "";
      qs("#aiStatus").textContent = "";
      qs("#editToggle").checked=false; qs("#reviewText").setAttribute("readonly","");

      if (xp==="Not great"){
        qs("#experience").classList.add("hidden");
        qs("#negative").classList.remove("hidden"); qs("#negative").setAttribute("aria-hidden","false");
      } else {
        qs("#experience").classList.add("hidden");
        qs("#positive").classList.remove("hidden"); qs("#positive").setAttribute("aria-hidden","false");
        // Google-first: craft stays hidden until asked
        qs("#craftWrap").classList.add("hidden");
      }
    }

    function attachCopyBehavior(){
      const btn=qs("#copyBtn"); const label=btn.querySelector(".btn-label"); const original=label.textContent;
      btn.addEventListener("click", async ()=>{
        const txt=qs("#reviewText").value.trim(); if (!txt) return;
        await copyText(txt);
        label.textContent="Copied"; qs("#sr-live").textContent="Copied to clipboard";
        setTimeout(()=>label.textContent=original, 2000);
      });
    }

    async function polishWithAI(){
      const status=qs("#aiStatus");
      if (!state.experience || state.experience==="Not great"){
        status.textContent="Choose Excellent or Good first.";
        return;
      }

      status.textContent="Polishing‚Ä¶";

      const details = detailsSummary(state.posDetails);
      const body = {
        restaurant: state.tenant.name,
        experience: state.experience,
        highlight: state.highlight || "none",
        keywords: [...state.selectedTags],
        extra: details
      };

      try {
        let text = "";

        if (TEST_GROQ_KEY) {
          // Direct browser call (TEST ONLY)
          text = await callGroqDirect(body);
        } else {
          // Serverless (recommended for real use)
          const r = await fetch("/.netlify/functions/review-ai", {
            method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
          });
          if (!r.ok) throw new Error("Function error " + r.status);
          const j = await r.json();
          text = (j?.text || "").trim();
        }

        if (text) {
          qs("#reviewText").value = text;
          qs("#copyBtn").removeAttribute("disabled");
          status.textContent = "AI suggestion applied.";
        } else {
          status.textContent = "AI returned no text. Try again.";
        }
      } catch (err) {
        status.textContent = `AI failed: ${err.message}`;
      }
    }

    function writeDeterministic(){
      if (!state.experience || state.experience==="Not great"){ qs("#aiStatus").textContent="Choose Excellent or Good first."; return; }
      const txt = writeShortReview({
        name: state.tenant.name,
        experience: state.experience,
        highlight: state.highlight,
        keywords: [...state.selectedTags],
        details: detailsSummary(state.posDetails)
      });
      qs("#reviewText").value = txt;
      qs("#copyBtn").removeAttribute("disabled");
      qs("#aiStatus").textContent = "Draft created.";
    }

    async function sendNegative(){
      const btn=qs("#sendNegative"); const status=qs("#negStatus");
      btn.disabled=true; status.textContent="Sending‚Ä¶";

      const payload = {
        tenantId: state.tenant.slug,
        restaurantName: state.tenant.name,
        timestampISO: new Date().toISOString(),
        selection:{ experience:"Not great" },
        answers: state.neg,
        userAgent: navigator.userAgent
      };

      try {
        await fetch("/.netlify/functions/feedback", {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload), keepalive:true
        });
      } catch (_) { /* ignore errors */ }

      status.textContent="";
      const form=qs("#negForm"); const done=qs("#negDone");
      form.classList.add("opacity-0","translate-y-2");
      setTimeout(()=>{ form.classList.add("hidden"); done.classList.remove("hidden") }, 220);
    }

    /****************
     * Initialization
     ****************/
    async function init(){
      // Read tenant slug (fallback to 'sahara' for easy testing)
      const path = location.pathname.replace(/^\/+/, "");
      const fromRoute = path.startsWith("r/") ? path.split("/")[1] : "";
      const fromQuery = new URLSearchParams(location.search).get("id") || "";
      const slug = (fromRoute || fromQuery || "sahara");

      // Fetch JSON (relative when opened as file://)
      const jsonUrl = (location.protocol === "file:")
        ? `data/tenants/${encodeURIComponent(slug)}.json`
        : `/data/tenants/${encodeURIComponent(slug)}.json`;

      const res = await fetch(jsonUrl).catch(()=>null);
      if (!res || !res.ok){
        qs("#restName").textContent = "Restaurant not found";
        return;
      }
      const cfg = await res.json(); state.tenant = cfg;

      // Brand + title
      setBrand(cfg.brand?.primary);
      qs("#restName").textContent = cfg.name;

      // Google link in sticky bar
      const gURL = googleUrl(cfg.google);
      const glTop = qs("#googleTopLink"); const tipTop=qs("#googleTipTop");
      if (gURL) { glTop.href = gURL; tipTop.textContent = ""; }
      else { glTop.removeAttribute("href"); tipTop.textContent = "Ask your provider to set a Google Maps URL or Place ID."; }

      // Build UI pieces
      renderKeywords(); renderHighlights(); buildPositiveDetailsUI(); buildNegativeUI();

      // Wire buttons
      qsa("[data-exp]").forEach(b=> b.addEventListener("click", ()=> setExperience(b.getAttribute("data-exp"))));
      qs("#revealAi").addEventListener("click", ()=> qs("#craftWrap").classList.toggle("hidden"));
      qs("#kwToggle").addEventListener("click", ()=>{ state.showAllKw=!state.showAllKw; renderKeywords(); });
      qs("#editToggle").addEventListener("change", e=>{ const ta=qs("#reviewText"); e.target.checked?ta.removeAttribute("readonly"):ta.setAttribute("readonly",""); });
      attachCopyBehavior();
      qs("#writeBtn").addEventListener("click", writeDeterministic);
      qs("#aiBtn").addEventListener("click", polishWithAI);
      qs("#sendNegative").addEventListener("click", sendNegative);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
